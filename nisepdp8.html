<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>nisepdp8</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #222;
      color: white;
      text-align: center;
      padding: 20px;
    }

    .panel-top {
        display: block;
        font-size: 2em;
        font-weight: bold;
        background-color: #ff6600;
        border: 3px solid #ffa500;
        color: #ffa500;
    }

    .lamp-title {
      margin: 20px 10px 10px;
      display: flex;
      justify-content: center;
      font-size:small;
    }

    .lamp-title-3 {
      margin: 0 5px;
      width: 80px;
      height: 20px;
      border-bottom: 3px solid #888;
    }

    .lamp-title-12 {
      margin: 0 5px;
      width: 380px;
      height: 20px;
      border-bottom: 3px solid #888;
    }

    .lamp-panel {
      margin: 10px 10px 20px;
      display: flex;
      justify-content: center;
    }

    .switch-panel, .control-panel {
      margin: 20px 5px;
      display: flex;
      justify-content: center;
    }

    .nolamp {
      width: 20px;
      height: 20px;
      margin: 0 5px;
    }

   .lamp {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: #444; /* OFF */
      box-shadow: 0 0 5px #000;
      margin: 0 5px;
    }

    .lamp.on {
      background-color: limegreen; /* ON */
      box-shadow: 0 0 10px limegreen;
    }

    .switch {
      width: 20px;
      height: 50px;
      background-color: #555;
      margin: 0 5px;
      cursor: pointer;
    }

    .switch.on {
      background-color: orange;
    }

    .gap {
      width: 0px;
      height: 20px;
      margin: 0 5px;
    }

    .control-button {
      padding: 10px 15px;
      background-color: #666;
      border: none;
      border-radius: 4px;
      color: white;
      margin: 0 10px;
      cursor: pointer;
    }

    .control-button:hover {
      background-color: #888;
    }

    .console {
      text-align: left;
      margin: 15px auto;
      max-width: 1200px;
    }
    .key-input {
      line-height: 21px;
      margin: 10px auto;
      }
    .teleprinter-output p {
      margin: 10px auto;
    }
    .teleprinter-output pre {
      background-color: #cca;
      color: #222;
      overflow: auto;
      padding: 1.5em;
      font-size: 15px;
      line-height: 21px;
      margin: 10px auto;
      }
    }
  </style>
</head>
<body>
  <div class="panel-top">nisepdp8</div>

  <!-- ランプ表示（12ビット） -->
  <div class="lamp-title">
    <div class="lamp-title-3">Data Field</div>
    <div class="gap"></div>
    <div class="lamp-title-3">Inst Field</div>
    <div class="gap"></div>
    <div class="lamp-title-12">Program Counter</div>
  </div>
  <div class="lamp-panel">
    <div class="lamp" id="lampd0"></div>
    <div class="lamp" id="lampd1"></div>
    <div class="lamp" id="lampd2"></div>
    <div class="gap"></div>
    <div class="lamp" id="lampi0"></div>
    <div class="lamp" id="lampi1"></div>
    <div class="lamp" id="lampi2"></div>
    <div class="gap"></div>
    <div class="lamp" id="lamp0"></div>
    <div class="lamp" id="lamp1"></div>
    <div class="lamp" id="lamp2"></div>
    <div class="gap"></div>
    <div class="lamp" id="lamp3"></div>
    <div class="lamp" id="lamp4"></div>
    <div class="lamp" id="lamp5"></div>
    <div class="gap"></div>
    <div class="lamp" id="lamp6"></div>
    <div class="lamp" id="lamp7"></div>
    <div class="lamp" id="lamp8"></div>
    <div class="gap"></div>
    <div class="lamp" id="lamp9"></div>
    <div class="lamp" id="lamp10"></div>
    <div class="lamp" id="lamp11"></div>
  </div>

  <div class="lamp-title">
    <div class="lamp-title-3"></div>
    <div class="gap"></div>
    <div class="lamp-title-3"></div>
    <div class="gap"></div>
    <div class="lamp-title-12">Memory Address</div>
  </div>
  <div class="lamp-panel">
    <div class="nolamp"></div>
    <div class="nolamp"></div>
    <div class="nolamp"></div>
    <div class="gap"></div>
    <div class="nolamp"></div>
    <div class="nolamp"></div>
    <div class="nolamp"></div>
    <div class="gap"></div>
    <div class="lamp" id="lampma0"></div>
    <div class="lamp" id="lampma1"></div>
    <div class="lamp" id="lampma2"></div>
    <div class="gap"></div>
    <div class="lamp" id="lampma3"></div>
    <div class="lamp" id="lampma4"></div>
    <div class="lamp" id="lampma5"></div>
    <div class="gap"></div>
    <div class="lamp" id="lampma6"></div>
    <div class="lamp" id="lampma7"></div>
    <div class="lamp" id="lampma8"></div>
    <div class="gap"></div>
    <div class="lamp" id="lampma9"></div>
    <div class="lamp" id="lampma10"></div>
    <div class="lamp" id="lampma11"></div>
  </div>

  <div class="lamp-title">
    <div class="lamp-title-3"></div>
    <div class="gap"></div>
    <div class="lamp-title-3"></div>
    <div class="gap"></div>
    <div class="lamp-title-12">Memory Buffer</div>
  </div>
  <div class="lamp-panel">
    <div class="nolamp"></div>
    <div class="nolamp"></div>
    <div class="nolamp"></div>
    <div class="gap"></div>
    <div class="nolamp"></div>
    <div class="nolamp"></div>
    <div class="nolamp"></div>
    <div class="gap"></div>
    <div class="lamp" id="lampmb0"></div>
    <div class="lamp" id="lampmb1"></div>
    <div class="lamp" id="lampmb2"></div>
    <div class="gap"></div>
    <div class="lamp" id="lampmb3"></div>
    <div class="lamp" id="lampmb4"></div>
    <div class="lamp" id="lampmb5"></div>
    <div class="gap"></div>
    <div class="lamp" id="lampmb6"></div>
    <div class="lamp" id="lampmb7"></div>
    <div class="lamp" id="lampmb8"></div>
    <div class="gap"></div>
    <div class="lamp" id="lampmb9"></div>
    <div class="lamp" id="lampmb10"></div>
    <div class="lamp" id="lampmb11"></div>
  </div>

  <div class="lamp-title">
    <div class="lamp-title-3"></div>
    <div class="gap"></div>
    <div class="lamp-title-3">Link</div>
    <div class="gap"></div>
    <div class="lamp-title-12">Accumulator</div>
  </div>
  <div class="lamp-panel">
    <div class="nolamp"></div>
    <div class="nolamp"></div>
    <div class="nolamp"></div>
    <div class="gap"></div>
    <div class="nolamp"></div>
    <div class="nolamp"></div>
    <div class="lamp" id="lampl"></div>
    <div class="gap"></div>
    <div class="lamp" id="lampac0"></div>
    <div class="lamp" id="lampac1"></div>
    <div class="lamp" id="lampac2"></div>
    <div class="gap"></div>
    <div class="lamp" id="lampac3"></div>
    <div class="lamp" id="lampac4"></div>
    <div class="lamp" id="lampac5"></div>
    <div class="gap"></div>
    <div class="lamp" id="lampac6"></div>
    <div class="lamp" id="lampac7"></div>
    <div class="lamp" id="lampac8"></div>
    <div class="gap"></div>
    <div class="lamp" id="lampac9"></div>
    <div class="lamp" id="lampac10"></div>
    <div class="lamp" id="lampac11"></div>
  </div>

  <!-- スイッチ群 -->
  <div class="switch-panel">
    <div class="switch" id="switchd0"></div>
    <div class="switch" id="switchd1"></div>
    <div class="switch" id="switchd2"></div>
    <div class="gap"></div>
    <div class="switch" id="switchi0"></div>
    <div class="switch" id="switchi1"></div>
    <div class="switch" id="switchi2"></div>
    <div class="gap"></div>
    <div class="switch" id="switch0"></div>
    <div class="switch" id="switch1"></div>
    <div class="switch" id="switch2"></div>
    <div class="gap"></div>
    <div class="switch" id="switch3"></div>
    <div class="switch" id="switch4"></div>
    <div class="switch" id="switch5"></div>
    <div class="gap"></div>
    <div class="switch" id="switch6"></div>
    <div class="switch" id="switch7"></div>
    <div class="switch" id="switch8"></div>
    <div class="gap"></div>
    <div class="switch" id="switch9"></div>
    <div class="switch" id="switch10"></div>
    <div class="switch" id="switch11"></div>
  </div>

  <!-- 操作キー群 -->
  <div class="control-panel">
    <button class="control-button" id="start">Start</button>
    <button class="control-button" id="loadadd">LoadAdd</button>
    <button class="control-button" id="dep">Dep</button>
    <button class="control-button" id="exam">Exam</button>
    <button class="control-button" id="cont">Cont</button>
    <button class="control-button" id="stop">Stop</button>
    <button class="control-button" id="step">SingStep</button>
  </div>

  <div class="console">
    <!-- コンソールプリンタ出力 -->
    <div class="teleprinter-output">
      <p>teleprinter output</p>
      <pre id="teleprinter"></pre>
    </div>

    <!-- コンソールキー入力 -->
    <div class="key-input">
      key input <input type="text" id="keyinput" size="100">
    </div>
  </div>

  <script>
    var RUNFF = 0;
    var DF,IF,PC,MA,MB,L,AC,IR,I,Z;
    var FIELD = [];
    var KEY_BUFFER;
    var KEY_FLAG = 0;
    var TELEPRINTER_BUFFER;
    var TELEPRINTER_FLAG=0;
    for(var i=0; i<8; i++) {
      FIELD[i] = new Uint16Array(4096);
    }

    // スイッチのON/OFFを切り替える
    for (var i = 0; i < 3; i++) {
      (function(n){
        var sw = document.getElementById('switchd' + n);
        sw.addEventListener('click', function() {
          sw.classList.toggle('on');
        });

      })(i);
    }
    for (var i = 0; i < 3; i++) {
      (function(n){
        var sw = document.getElementById('switchi' + n);
        sw.addEventListener('click', function() {
          sw.classList.toggle('on');
        });
      })(i);
    }
    for (var i = 0; i < 12; i++) {
      (function(n){
        var sw = document.getElementById('switch' + n);
        sw.addEventListener('click', function() {
          sw.classList.toggle('on');
        });
      })(i);
    }

    // スイッチの状態を取得
    function getSwitchValue() {
      var value = 0;
      for (var i = 0; i < 12; i++) {
        value |= (function(n){
          var sw = document.getElementById('switch' + n);
          if (sw.classList.contains('on')) {
            return (1 << (11 - i));
          }
        })(i);
      }
      return value;
    }

    function getDFSwitchValue() {
      var value = 0;
      for (var i = 0; i < 3; i++) {
        value |= (function(n){
          var sw = document.getElementById('switchd' + n);
          if (sw.classList.contains('on')) {
            return (1 << (2 - i));
          }
        })(i);
      }
      return value;
    }

    function getIFSwitchValue() {
      var value = 0;
      for (var i = 0; i < 3; i++) {
        value |= (function(n){
          var sw = document.getElementById('switchi' + n);
          if (sw.classList.contains('on')) {
            return (1 << (2 - i));
          }
        })(i);
      }
      return value;
    }

    // ランプに値を反映
    function setDFRegisterValue(value) {
      for (var i = 0; i < 3; i++) {
        (function(n){
          var lamp = document.getElementById('lampd' + n);
          if (value & (1 << (2 - i))) {
            lamp.classList.add('on');
          } else {
            lamp.classList.remove('on');
          }
        })(i);
      }
    }
    function setIFRegisterValue(value) {
      for (var i = 0; i < 3; i++) {
        (function(n){
          var lamp = document.getElementById('lampi' + n);
          if (value & (1 << (2 - i))) {
            lamp.classList.add('on');
          } else {
            lamp.classList.remove('on');
          }
        })(i);
      }
    }
    function setPCRegisterValue(value) {
      for (var i = 0; i < 12; i++) {
        (function(n){
          var lamp = document.getElementById('lamp' + n);
          if (value & (1 << (11 - i))) {
            lamp.classList.add('on');
          } else {
            lamp.classList.remove('on');
          }
        })(i);
      }
    }
    function setMARegisterValue(value) {
      for (var i = 0; i < 12; i++) {
        (function(n){
          var lamp = document.getElementById('lampma' + n);
          if (value & (1 << (11 - i))) {
            lamp.classList.add('on');
          } else {
            lamp.classList.remove('on');
          }
        })(i);
      }
    }
    function setMBRegisterValue(value) {
      for (var i = 0; i < 12; i++) {
        (function(n){
          var lamp = document.getElementById('lampmb' + n);
          if (value & (1 << (11 - i))) {
            lamp.classList.add('on');
          } else {
            lamp.classList.remove('on');
          }
        })(i);
      }
    }
    function setLRegisterValue(value) {
        var lamp = document.getElementById('lampl');
        if (value) {
          lamp.classList.add('on');
        } else {
          lamp.classList.remove('on');
        }
    }
    function setACRegisterValue(value) {
      for (var i = 0; i < 12; i++) {
        (function(n){
          var lamp = document.getElementById('lampac' + n);
          if (value & (1 << (11 - i))) {
            lamp.classList.add('on');
          } else {
            lamp.classList.remove('on');
          }
        })(i);
      }
    }

    // レジスタ ---> ランプ
    function setLamp() {
      setDFRegisterValue(DF);
      setIFRegisterValue(IF);
      setPCRegisterValue(PC);

      setMARegisterValue(MA);
      setMBRegisterValue(MB);

      setLRegisterValue(L);
      setACRegisterValue(AC);
    }

    // 実行
    function doStep() {

      MA = PC;

      // FETCH state

      PC++;
      MB = FIELD[IF][MA];
      IR = MB >> 9;

      var fieldNo = IF;
      if (IR <= 5) {    // AND,TAD,ISZ,DCA,JMS,JMP

        I = MB & 256;   // indirect
        Z = MB & 128;   // zero page

        MA = (MA & 3968) + (MB & 127);  // 3968 = 07600
        if (Z == 0) {
          // zero page
          MA = MA & 127;
        }

        if (I != 0) {
          // DEFER state
          // Autoindex Addressing (0010..0017)
          if ((MA >= 8) && (MA <= 15)) {
            FIELD[IF][MA]++;
          }
          MA = FIELD[IF][MA];
          fieldNo = DF;
        }
      }
      
      //EXECUTE state
      SENSE = 0 + FIELD[fieldNo][MA];

      switch(IR) {
        case 0: // AND
          AC &= SENSE;
          break;
        case 1: // TAD
          AC += SENSE;
          if (AC & 4096) {
            L = (~L) & 1;
          }
          AC &= 4095;
          break;
        case 2: // ISZ
          SENSE = (SENSE + 1) & 4095;
          FIELD[fieldNo][MA] = SENSE;
          if (SENSE == 0) {
            PC = PC + 1;
          }
          break;
        case 3: // DCA
          FIELD[fieldNo][MA] = AC;
          AC = 0;
          break;
        case 4: // JMS
          FIELD[IF][MA] = PC;
          PC = MA + 1;
          break;
        case 5: // JMP
          PC = MA;
          break;
        case 6: // IOT
          doIOT(MB);
          break;
        case 7: // OPR
          if ((MB & 256) == 0) {
            // GROUP 1
            doGroup1(MB);
          }
          else {
            if ((MB & 1) == 0) {
              if ((MB & 8) == 0) {
                // GROUP 2 OR
                doGroup2or(MB);
              }
              else {
                // GROUP 2 AND
                doGroup2and(MB);
              }
            }
            else {
              // GROUP 3
              doGroup3(MB);
            }
          }
          break;
        default:
          console.log('illegal instruction: ' + IR);
          regDump();
          break;
      }
      if (RUNFF) {
        setTimeout(doStep,0);
      }
      setLamp();
    }
    // OPR
    function doGroup1(m) {
      if (m & 128) {  // CLA
        AC = 0;
      }
      if (m & 64) { // CLL
        L = 0;
      }
      if (m & 32) { // CMA
        AC = (~AC) & 4095;
      }
      if (m & 16) { // CML
        L = (~L) & 1;
      }
      if (m & 1) {  // IAC
        AC |= L << 12;
        AC = (AC + 1);
        L = (AC & 4096) >> 12;
        AC &= 4095;
      }
      if (m & 8) {  // RAR
        AC = AC | (L << 12);
        L = AC & 1;
        AC = AC >> 1;
        if (m & 2) {  // BSW
          AC = AC | (L << 12);
          L = AC & 1;
          AC = AC >> 1;
        }        
      }
      if (m & 4) {  // RAL
        AC = AC << 1 | L;
        L = AC >> 12;
        AC = AC & 4095;
        if (m & 2) {  // BSW
          AC = AC << 1 | L;
          L = AC >> 12;
          AC = AC & 4095;
        }
      }
      if ((m & 14) == 2) {  // BSW
        AC = ((AC << 6) & 4095) + (AC >> 6);
      }
    }
    function doGroup2or(m) {
      if (m & 64) {   // SMA
        if (AC & 2048) {
          PC = PC + 1;
        }
      }
      if (m & 32) {   // SZA
        if (AC == 0) {
          PC = PC + 1;
        }
      }
      if (m & 16) {    // SNL
        if (L) {
          PC = PC + 1;
        }
      }
      if (m & 128) {  // CLA
        AC = 0;
      }
      if (m & 4) {    // OSR
        AC = AC | getSwitchValue();
      }
      if (m & 2) {    // HLT
        RUNFF = 0;
      }
    }
    function doGroup2and(m) {
      var skip = 1;
      if (m & 64) {   // SPA
        if (AC & 2048) {
          skip = 0;
        }
      }
      if (m & 32) {   // SNA
        if (AC == 0) {
          skip = 0;
        }
      }
      if (m & 16) {   // SZL
        if (L) {
          skip = 0;
        }
      }
      if (skip) {
        PC = PC + 1;
      }
      if (m & 128) {    // CLA
        AC = 0;
      }
      if (m & 2) {    // HLT
        RUNFF = 0;
      }
      if (m & 4) {    // OSR
        AC = AC | getSwitchValue();
      }
    }
    function doGroup3(m) {
      if (m & 128) {  // CLA
        AC = 0;
      }
      if (m & 64) {   // MQA
      }
      if (m & 32) {   // SCA
      }
      if (m & 16) {   // MQL
      }
      if (m & 814) {  // CODE 
      }
    }
    function doIOT(m) {
      // device 03=input (KEY) 04=output(TELEPRINTER)
      var kb, tp, ln, cc;
      switch(m) {
        case 3097:  // KSF 6031 Keyboard Skip if Flag
          kb = document.getElementById('keyinput');
          if (kb.value.length > 0) {
            PC++;
          }
          break;
        case 3098:  // KCC 6032 Keyboard Clear and read Character
          //break;
        case 3100:  // KRS 6034 Keybord Read Static
          kb = document.getElementById('keyinput');
          ln = kb.value;
          if (ln.length > 0) {
            cc = ln.charAt(0);
            AC = (cc.charCodeAt(0)) & 255;
            kb.value = ln.slice(1);
          }
          break;
        case 3102:  // KRB 6036 Keybord Read and Begin next read
          break;
        case 3105:  // TSF 6041 Teleprinter Skip if Flag
          PC++;
          break;
        case 3106:  // TCF 6042 Teleprinter Clear Flag
          break;
        case 3108:  // TPC 6044 Teleprinter Print Character
          // fall-down
          //break;
        case 3110:  // TLS 6046 Teleprinter Load and Start
          tp = document.getElementById('teleprinter');
          tp.textContent += String.fromCharCode(AC & 255);
          break;
        default:
          console.log('illegal instruction: ' + OCT2STR12(m));
          regDump();
          break;
      }
    }
    function regDump() {
      console.log('     L:' + L);
      console.log('    AC:' + OCT2STR12(AC));
      console.log('    PC:' + OCT2STR12(PC));
      console.log('    MA:' + OCT2STR12(MA));
      console.log('    MB:' + OCT2STR12(MB));
      console.log('    DF:' + OCT2STR12(DF));
      console.log('    IF:' + OCT2STR12(IF));
    }
    function OCT2STR12(oct) {
      return ''.concat((oct >> 9), ((oct >> 6) & 7), ((oct >> 3) & 7), (oct & 7));
    }

    // 操作キー：Start
    document.getElementById('start').addEventListener('click', function() {
      if (RUNFF == 1) {return};

      AC = 0;
      L = 0;
      MB = 0;
      IR = 0;
      MA = PC;
      RUNFF = 1;

      setTimeout(doStep, 0);
      //while (RUNFF == 1) {
      //  doStep();
      //  setLamp();
      //}
    });

    // 操作キー：LoadAdd
    document.getElementById('loadadd').addEventListener('click', function() {
      PC = getSwitchValue();
      DF = getDFSwitchValue();
      IF = getIFSwitchValue();
      setLamp();
    });

    // 操作キー：Dep (Deposit)
    document.getElementById('dep').addEventListener('click', function() {
      MB = getSwitchValue();
      MA = PC;
      FIELD[IF][MA] = MB;
      PC++;
      setLamp();
    });

    // 操作キー：Exam
    document.getElementById('exam').addEventListener('click', function() {
      MA = PC;
      MB = FIELD[IF][MA];
      PC++;
      setLamp();
    });

    // 操作キー：Cont (Continue)
    document.getElementById('cont').addEventListener('click', function() {
      RUNFF = 1;
      setTimeout(doStep, 0);
    });

    // 操作キー：Stop
    document.getElementById('stop').addEventListener('click', function() {
      RUNFF = 0;
    });

    // 操作キー：Step
    document.getElementById('step').addEventListener('click', function() {
      RUNFF = 0;
      setTimeout(doStep, 0);
    });

  </script>
</body>
</html>
